<!DOCTYPE html>
<html>
<body>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyA4nwk8ZPeVvoLOR4UyPLP-yVUyhlinEN8",
 authDomain: "blackpophun.firebaseapp.com",
 databaseURL: "https://blackpophun-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "blackpophun",
 storageBucket: "blackpophun.appspot.com",
 messagingSenderId: "735578888290",
 appId: "1:735578888290:web:b68c60a5bdba76880ed93b"
});

const db = firebase.database();
const params = new URLSearchParams(location.search);
const key = params.get("key");

/* ดึง IP */
fetch("https://api.ipify.org?format=json")
.then(r=>r.json())
.then(ipData=>{
 const userIP = ipData.ip;

 db.ref("keys/"+key).get().then(snap=>{
   if(!snap.exists()) return output("INVALID");

   const d = snap.val();
   if(Date.now() > d.expiresAt) return output("EXPIRED");

   if(!d.ip){
     db.ref("keys/"+key).update({ip:userIP,used:true});
     return output("SUCCESS");
   }

   if(d.ip !== userIP) return output("IP_MISMATCH");

   output("SUCCESS");
 });
});

function output(text){
 document.body.innerText = text;
}
</script>
</body>
</html>

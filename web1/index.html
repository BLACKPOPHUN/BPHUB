<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlackpopHub</title>
<style>
body { font-family: sans-serif; background: #121212; color: white; padding: 20px; margin:0; }
h2 { text-align: center; font-size: 28px; margin-bottom: 20px; }
input, button, textarea { border-radius: 6px; border:none; outline:none; }
input { width: calc(100% - 16px); padding: 8px; margin: 5px 0; }
button { padding:10px 15px; margin:5px 0; background:#ff003c; color:white; cursor:pointer; transition:0.3s; }
button:hover { background:#2563eb; }
a { color: #00f; cursor:pointer; display:block; text-align:center; margin-top:5px; }
.box { background:#1e1e1e; padding:15px; margin:0 auto 20px auto; width:90%; max-width:700px; border-radius:12px; box-shadow:0 0 10px #00000050; position:relative; }
textarea { width:100%; height:100px; padding:10px; resize:none; background:#111; color:#eee; font-size:14px; }
textarea[readonly]{background:#222;}
.msg { color: #8bf48a; display:none; margin-top:8px; text-align:center; }
#logout { position:fixed; left:10px; bottom:10px; padding:15px 20px; background:#ff6600; font-size:16px; border-radius:8px; cursor:pointer; display:none; transition:0.3s; }
#logout:hover { background:#ff3300; transform: scale(1.05);}
#username-btn{position:fixed;right:10px;top:10px;background:#2563eb;padding:10px 15px;border-radius:8px;cursor:pointer;display:none;}
#user-time-box{position:fixed;right:10px;top:50px;background:#333;padding:10px;border-radius:8px;display:none;max-width:200px;word-break:break-word;}
.edit-btn{background:#ff9800;margin-left:10px;}
.edit-btn:hover{background:#f57c00;}
.save-btn{background:#4caf50;}
.save-btn:hover{background:#45a049;}
.cancel-btn{background:#666;}
.cancel-btn:hover{background:#555;}
.delete-btn{background:#f44336;position:absolute;top:15px;right:15px;}
.delete-btn:hover{background:#d32f2f;}
.editing-indicator{color:#ff9800;font-size:12px;margin-top:5px;display:none;}
#add-script-btn{background:#4caf50;width:90%;max-width:700px;display:none;margin:20px auto;font-size:18px;padding:15px;}
#add-script-btn:hover{background:#45a049;}
.online-users{position:fixed;left:10px;top:10px;background:#333;padding:10px;border-radius:8px;font-size:12px;max-width:150px;display:none;}
.online-dot{display:inline-block;width:8px;height:8px;background:#4caf50;border-radius:50%;margin-right:5px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.5;}}
@media(max-width:480px){
    h2{font-size:24px;}
    #logout, #username-btn{padding:10px 12px;font-size:14px;}
    .online-users{position:static;margin-bottom:10px;max-width:100%;}
}
</style>
</head>
<body>

<!-- Login -->
<div id="login-container" class="box">
    <h2>Login</h2>
    <input type="text" id="login-username" placeholder="Username"><br>
    <input type="password" id="login-password" placeholder="Password"><br>
    <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <a onclick="showRegister()">‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™</a>
    <p id="login-msg" style="color:red;"></p>
</div>

<!-- Register / ‡∏´‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î -->
<div id="register-container" class="box" style="display:none;">
    <h2>‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™</h2>
    <p>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login</p>
    <button onclick="openCodeSite()">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î</button>
    <a onclick="showLogin()">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login</a>
</div>

<!-- Scripts -->
<div id="script-container" style="display:none;">
<div id="online-users" class="online-users"></div>
<h2>Script Roblox</h2>
<div id="scripts-list"></div>
<button id="add-script-btn" onclick="addNewScript()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á Script ‡πÉ‡∏´‡∏°‡πà</button>
</div>

<div id="logout" onclick="logout()">Logout</div>
<div id="username-btn" onclick="toggleUserTime()">User</div>
<div id="user-time-box"></div>

<script>
// ====== GLOBAL VARIABLES ======
let currentUser = null;
let loginTime = null;
let intervalTimer = null;
let syncTimer = null;
let heartbeatTimer = null;
let scripts = [];
let sessionId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let storageAvailable = false;

// ====== INITIAL SCRIPTS DATA ======
const initialScripts = [
    {
        id: 1,
        title: "Script BPHub ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ BlackpopHub",
        content: `-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢
-- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
--BlackpopHub
        
loadstring(game:HttpGet(("https://raw.githubusercontent.com/BLACKPOPHUN/script-BPHUB/refs/heads/main/Script/BPHUB"), true))() 
        
--‡∏£‡∏´‡∏±‡∏™ 7952
-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á
-- ‡∏£‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏à‡∏´‡∏≤‡∏¢`
    },
    {
        id: 2,
        title: "Script 99 ‡∏Ñ‡∏∑‡∏ô",
        content: `loadstring(game:HttpGet("https://raw.githubusercontent.com/BLACKPOPHUN/script-BPHUB/refs/heads/main/Script/FoxnameHub-99Day"))()`
    },
    {
        id: 3,
        title: "Script 99 ‡∏Ñ‡∏∑‡∏ô ‡πÄ‡∏°‡∏ô‡∏π‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢",
        content: `-- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏¢‡∏¢

    loadstring(game:HttpGet("https://raw.githubusercontent.com/BLACKPOPHUN/script-BPHUB/refs/heads/main/Script/TH-99Day"))()

-- ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á!!`
    },
    {
        id: 4,
        title: "Script Auto ‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÄ‡∏û‡∏ä‡∏£ 99 ‡∏Ñ‡∏∑‡∏ô",
        content: ` loadstring(game:HttpGet(("https://raw.githubusercontent.com/BLACKPOPHUN/script-BPHUB/refs/heads/main/Script/Auto-farm-Gem-99Day"), true))()
--‡∏£‡∏´‡∏±‡∏™ 7952`
    },
    {
        id: 5,
        title: "Script ‡∏ï‡∏Å‡∏õ‡∏•‡∏≤",
        content: `loadstring(game:HttpGet(("https://raw.githubusercontent.com/BLACKPOPHUN/script-BPHUB/refs/heads/main/Script/Auto-Farm-Fishing"), true))()`
    }
];

// ====== CHECK STORAGE AVAILABILITY ======
async function checkStorage() {
    if (typeof window.storage !== 'undefined') {
        try {
            await window.storage.set('test_key', 'test', true);
            await window.storage.delete('test_key', true);
            storageAvailable = true;
            console.log('‚úÖ Persistent Storage ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            return true;
        } catch (e) {
            console.log('‚ö†Ô∏è Storage ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:', e);
        }
    }
    storageAvailable = false;
    console.log('‚ö†Ô∏è ‡πÉ‡∏ä‡πâ localStorage ‡πÅ‡∏ó‡∏ô (‡πÑ‡∏°‡πà sync ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)');
    return false;
}

// ====== STORAGE HELPERS ======
async function getSharedData(key) {
    if (!storageAvailable) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    }
    
    try {
        const result = await window.storage.get(key, true);
        return result ? JSON.parse(result.value) : null;
    } catch (error) {
        return null;
    }
}

async function setSharedData(key, value) {
    if (!storageAvailable) {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    }
    
    try {
        await window.storage.set(key, JSON.stringify(value), true);
        return true;
    } catch (error) {
        console.error('Storage error:', error);
        return false;
    }
}

async function deleteSharedData(key) {
    if (!storageAvailable) {
        localStorage.removeItem(key);
        return true;
    }
    
    try {
        await window.storage.delete(key, true);
        return true;
    } catch (error) {
        return false;
    }
}

async function listSharedKeys(prefix) {
    if (!storageAvailable) {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(prefix)) {
                keys.push(key);
            }
        }
        return keys;
    }
    
    try {
        const result = await window.storage.list(prefix, true);
        return result && result.keys ? result.keys : [];
    } catch (error) {
        return [];
    }
}

// ====== LOGIN & REGISTER ======
function showRegister(){ 
    document.getElementById('login-container').style.display='none'; 
    document.getElementById('register-container').style.display='block'; 
    document.getElementById('login-msg').innerText=''; 
}

function showLogin(){ 
    document.getElementById('login-container').style.display='block'; 
    document.getElementById('register-container').style.display='none'; 
    document.getElementById('script-container').style.display='none'; 
}

function openCodeSite(){
    window.open("https://sub2unlock.me/MjMZMF6","_blank");
}

async function login(){
    const u = document.getElementById("login-username").value.trim();
    const p = document.getElementById("login-password").value.trim();

    if(u==="BP0998" && p==="9980"){
        currentUser = {username:"BP0998", admin:false, lastLogin:new Date().toLocaleString(), sessionId:sessionId};
        localStorage.setItem("logged_in_user", JSON.stringify(currentUser));
        await showScript();
        return;
    }

    if(u==="admin" && p==="2337952"){
        currentUser = {username:"admin", admin:true, lastLogin:new Date().toLocaleString(), sessionId:sessionId};
        localStorage.setItem("logged_in_user", JSON.stringify(currentUser));
        await showScript();
        return;
    }

    document.getElementById("login-msg").innerText = "Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
}

async function showScript(){
    document.getElementById('login-container').style.display='none';
    document.getElementById('register-container').style.display='none';
    document.getElementById('script-container').style.display='block';
    document.getElementById('logout').style.display='block';
    document.getElementById('username-btn').style.display='block';
    document.getElementById('username-btn').innerText = currentUser.username;
    loginTime = new Date();
    startTimer();
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    if(currentUser.admin){
        document.getElementById('add-script-btn').style.display='block';
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    await updateOnlineStatus();
    document.getElementById('online-users').style.display='block';
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Scripts
    await loadScripts();
    renderScripts();
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Real-time Sync
    startRealtimeSync();
    startHeartbeat();
}

async function logout(){
    // ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
    if(currentUser){
        await deleteSharedData('online:' + currentUser.sessionId);
    }
    
    currentUser=null;
    clearInterval(intervalTimer);
    clearInterval(syncTimer);
    clearInterval(heartbeatTimer);
    localStorage.removeItem("logged_in_user");
    document.getElementById('script-container').style.display='none';
    document.getElementById('logout').style.display='none';
    document.getElementById('username-btn').style.display='none';
    document.getElementById('online-users').style.display='none';
    showLogin();
}

// ====== ONLINE STATUS ======
async function updateOnlineStatus(){
    if(!currentUser) return;
    
    const onlineData = {
        username: currentUser.username,
        timestamp: Date.now()
    };
    
    await setSharedData('online:' + currentUser.sessionId, onlineData);
}

async function getOnlineUsers(){
    try {
        const keys = await listSharedKeys('online:');
        const now = Date.now();
        const onlineUsers = new Set();
        
        for(const key of keys){
            try {
                const data = await getSharedData(key);
                if(data && (now - data.timestamp) < 15000){ // ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    onlineUsers.add(data.username);
                } else {
                    // ‡∏•‡∏ö session ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                    await deleteSharedData(key);
                }
            } catch(e){}
        }
        
        return Array.from(onlineUsers);
    } catch(error){
        return [currentUser ? currentUser.username : ''];
    }
}

async function updateOnlineDisplay(){
    const users = await getOnlineUsers();
    const box = document.getElementById('online-users');
    if(box && users.length > 0){
        const uniqueUsers = [...new Set(users)];
        box.innerHTML = '<span class="online-dot"></span>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: ' + uniqueUsers.join(', ');
    }
}

function startHeartbeat(){
    heartbeatTimer = setInterval(async () => {
        await updateOnlineStatus();
    }, 5000); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}

// ====== SCRIPTS MANAGEMENT ======
async function loadScripts(){
    const saved = await getSharedData('scripts_data');
    if(saved && Array.isArray(saved) && saved.length > 0){
        scripts = saved;
    } else {
        scripts = [...initialScripts];
        await saveScripts();
    }
}

async function saveScripts(){
    await setSharedData('scripts_data', scripts);
}

function renderScripts(){
    const container = document.getElementById('scripts-list');
    container.innerHTML = '';
    
    scripts.forEach(script => {
        const box = createScriptBox(script);
        container.appendChild(box);
    });
}

function createScriptBox(script){
    const box = document.createElement('div');
    box.className = 'box';
    box.id = 'box-' + script.id;
    
    let html = `
        <h3 id="title-${script.id}" contenteditable="false">${script.title}</h3>
        <textarea id="text-${script.id}" readonly>${script.content}</textarea>
        <button onclick="copyFrom('text-${script.id}')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
    `;
    
    if(currentUser && currentUser.admin){
        html += `
            <button id="edit-${script.id}" class="edit-btn" onclick="editScript(${script.id})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button id="save-${script.id}" class="save-btn" style="display:none;" onclick="saveScript(${script.id})">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="cancel-${script.id}" class="cancel-btn" style="display:none;" onclick="cancelEdit(${script.id})">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="delete-btn" onclick="deleteScript(${script.id})">üóëÔ∏è ‡∏•‡∏ö</button>
        `;
    }
    
    html += `
        <div id="text-${script.id}-msg" class="msg">‚úî ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div>
        <div id="editing-${script.id}" class="editing-indicator">üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...</div>
    `;
    
    box.innerHTML = html;
    return box;
}

async function addNewScript(){
    const newId = Date.now();
    const newScript = {
        id: newId,
        title: "Script ‡πÉ‡∏´‡∏°‡πà",
        content: "// ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"
    };
    
    scripts.push(newScript);
    await saveScripts();
    renderScripts();
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    setTimeout(() => editScript(newId), 100);
}

async function deleteScript(id){
    if(!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
    
    // ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    await deleteSharedData('editing:' + id);
    
    scripts = scripts.filter(s => s.id !== id);
    await saveScripts();
    renderScripts();
}

// ====== EDIT SYSTEM ======
let originalContent = {};

async function editScript(id){
    const textarea = document.getElementById('text-' + id);
    const title = document.getElementById('title-' + id);
    
    if(!textarea || !title) return;
    
    originalContent[id] = {
        text: textarea.value,
        title: title.innerText
    };
    
    textarea.readOnly = false;
    textarea.style.background = '#1a3a1a';
    title.contentEditable = true;
    title.style.outline = '2px solid #ff9800';
    
    const editBtn = document.getElementById('edit-' + id);
    const saveBtn = document.getElementById('save-' + id);
    const cancelBtn = document.getElementById('cancel-' + id);
    
    if(editBtn) editBtn.style.display='none';
    if(saveBtn) saveBtn.style.display='inline-block';
    if(cancelBtn) cancelBtn.style.display='inline-block';
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö shared
    await setSharedData('editing:' + id, {
        username: currentUser.username,
        timestamp: Date.now()
    });
}

async function saveScript(id){
    const textarea = document.getElementById('text-' + id);
    const title = document.getElementById('title-' + id);
    
    if(!textarea || !title) return;
    
    const scriptIndex = scripts.findIndex(s => s.id === id);
    if(scriptIndex !== -1){
        scripts[scriptIndex].title = title.innerText.trim();
        scripts[scriptIndex].content = textarea.value;
        await saveScripts();
    }
    
    textarea.readOnly = true;
    textarea.style.background = '#222';
    title.contentEditable = false;
    title.style.outline = 'none';
    
    const editBtn = document.getElementById('edit-' + id);
    const saveBtn = document.getElementById('save-' + id);
    const cancelBtn = document.getElementById('cancel-' + id);
    
    if(editBtn) editBtn.style.display='inline-block';
    if(saveBtn) saveBtn.style.display='none';
    if(cancelBtn) cancelBtn.style.display='none';
    
    await deleteSharedData('editing:' + id);
    
    showMsg('text-' + id);
}

async function cancelEdit(id){
    const textarea = document.getElementById('text-' + id);
    const title = document.getElementById('title-' + id);
    
    if(!textarea || !title) return;
    
    if(originalContent[id]){
        textarea.value = originalContent[id].text;
        title.innerText = originalContent[id].title;
    }
    
    textarea.readOnly = true;
    textarea.style.background = '#222';
    title.contentEditable = false;
    title.style.outline = 'none';
    
    const editBtn = document.getElementById('edit-' + id);
    const saveBtn = document.getElementById('save-' + id);
    const cancelBtn = document.getElementById('cancel-' + id);
    
    if(editBtn) editBtn.style.display='inline-block';
    if(saveBtn) saveBtn.style.display='none';
    if(cancelBtn) cancelBtn.style.display='none';
    
    await deleteSharedData('editing:' + id);
}

// ====== UTILITY FUNCTIONS ======
function copyFrom(id){
    const ta = document.getElementById(id);
    if(!ta) return;
    const text = ta.value;
    navigator.clipboard.writeText(text).then(() => showMsg(id));
}

function showMsg(id){ 
    const msg = document.getElementById(id + '-msg'); 
    if(!msg) return;
    msg.style.display='block'; 
    setTimeout(() => msg.style.display='none', 2000);
}

function toggleUserTime(){
    const box = document.getElementById('user-time-box');
    box.style.display = (box.style.display==='none' || box.style.display==='')?'block':'none';
}

function startTimer(){
    intervalTimer = setInterval(async () => {
        if(!currentUser) return;
        let timeHTML = `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö: ${Math.floor((new Date()-loginTime)/1000)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ<br>`;
        timeHTML += `üïê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ${currentUser.lastLogin}`;
        document.getElementById('user-time-box').innerHTML = timeHTML;
    }, 1000);
}

// ====== REAL-TIME SYNC ======
function startRealtimeSync(){
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    updateOnlineDisplay();
    
    syncTimer = setInterval(async () => {
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
        await updateOnlineDisplay();
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ script
        for(const script of scripts){
            const id = script.id;
            const editingData = await getSharedData('editing:' + id);
            const indicator = document.getElementById('editing-' + id);
            
            if(!indicator) continue;
            
            if(editingData && editingData.username !== currentUser.username){
                const timeAgo = Math.floor((Date.now() - editingData.timestamp) / 1000);
                indicator.style.display = 'block';
                indicator.innerText = `üî¥ ${editingData.username} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç... (${timeAgo}s)`;
            } else {
                indicator.style.display = 'none';
            }
            
            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏≠‡∏á
            const textarea = document.getElementById('text-' + id);
            const title = document.getElementById('title-' + id);
            
            if(!editingData || editingData.username !== currentUser.username){
                const savedScripts = await getSharedData('scripts_data');
                if(savedScripts && Array.isArray(savedScripts)){
                    const savedScript = savedScripts.find(s => s.id === id);
                    
                    if(savedScript && textarea && title){
                        if(textarea.readOnly && savedScript.content !== textarea.value){
                            textarea.value = savedScript.content;
                        }
                        if(!title.isContentEditable && savedScript.title !== title.innerText){
                            title.innerText = savedScript.title;
                        }
                    }
                }
            }
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö script ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const currentScripts = await getSharedData('scripts_data');
        if(currentScripts && Array.isArray(currentScripts)){
            const currentIds = JSON.stringify(currentScripts.map(s => s.id).sort());
            const localIds = JSON.stringify(scripts.map(s => s.id).sort());
            
            if(currentIds !== localIds){
                scripts = currentScripts;
                renderScripts();
            }
        }
    }, 1000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}

// ====== AUTO-LOGIN ======
window.onload = async function(){
    await checkStorage();
    
    const stored = localStorage.getItem("logged_in_user");
    if(stored){
        try {
            currentUser = JSON.parse(stored);
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á sessionId ‡πÉ‡∏´‡∏°‡πà
            currentUser.sessionId = sessionId;
            localStorage.setItem("logged_in_user", JSON.stringify(currentUser));
            await showScript();
        } catch(e) {
            console.error('Error auto-login:', e);
            showLogin();
        }
    }
}

// ====== CLEANUP ON PAGE UNLOAD ======
window.addEventListener('beforeunload', async () => {
    if(currentUser){
        await deleteSharedData('online:' + currentUser.sessionId);
    }
});
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
import { getDatabase, ref, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4nwk8ZPeVvoLOR4UyPLP-yVUyhlinEN8",
  authDomain: "blackpophun.firebaseapp.com",
  databaseURL: "https://blackpophun-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "blackpophun",
  storageBucket: "blackpophun.firebasestorage.app",
  messagingSenderId: "735578888290",
  appId: "1:735578888290:web:b68c60a5bdba76880ed93b",
  measurementId: "G-LBD7BZD8EJ"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);

// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô deleteSharedData
async function deleteSharedData(path) {
  await remove(ref(database, path));
}
</script>

</body>
</html>
